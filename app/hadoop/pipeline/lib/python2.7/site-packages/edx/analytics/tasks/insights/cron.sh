#!/bin/bash

source /edx/app/hadoop/hadoop/etc/hadoop/hadoop-env.sh
source /edx/app/hadoop/hive/conf/hive-env.sh
source /edx/app/hadoop/sqoop/conf/sqoop-env.sh

#cd /edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights
source /edx/app/hadoop/pipeline/bin/activate


###database import####

database='ginkgo_edxapp'
destination='hdfs://localhost:9000/edx-analytics-pipeline/warehouse/'
credentials='/edx/etc/edx-analytics-pipeline/input.json'

#course enrollments
intervalstart='2017-04-01'
interval=2017-04-01-$(date +%Y-%m-%d)
overwritendays='5'
nreducetask='25'
pattern='[".*tracking.log.*",".*tracking.log-([0-9]+)-([0-9]).gz.*"]'

#performance
problemoutputroot='hdfs://localhost:9000/problem-response-reports/output/'
marker='hdfs://localhost:9000/edx-analytics-pipeline/marker/'


PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' \
luigi --module database_imports ImportAuthUserTask \
--destination $destination \
--credentials $credentials \
--database $database \
--overwrite 

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' \
luigi --module database_imports ImportAuthUserProfileTask \
--destination $destination \
--credentials $credentials \
--database $database \
--overwrite 

###End###

####course Enrollments###


PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' \
luigi --module enrollments CourseEnrollmentEventsTask \
--source '["hdfs://localhost:9000/data/"]' \
--pattern $pattern \
--warehouse-path 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse' \
--interval $interval  \
--n-reduce-task $nreducetask

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' luigi   \
--module enrollments CourseEnrollmentTask \
--interval $interval \
--source '["hdfs://localhost:9000/data/"]' \
--pattern $pattern \
--warehouse-path 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse'  \
--n-reduce-task $nreducetask \
--overwrite-n-days $overwritendays \
--mapreduce-engine "hadoop" \
--remote-log-level "DEBUG" \
--output-root 'hdfs://localhost:9000/edx-analytics-pipeline/event-export-by-course/output/'

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights/' \
luigi --module enrollments CourseMetaSummaryEnrollmentIntoMysql  \
--interval $interval \
--source '["hdfs://localhost:9000/data"]' \
--pattern $pattern \
--warehouse-path 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse'  \
--n-reduce-task $nreducetask \
--overwrite-n-days $overwritendays \
--mapreduce-engine "hadoop" \
--remote-log-level "DEBUG" \
--override-hive True \
--override-mysql True 

### End ##

### Demographics ###

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights/' \
luigi --module enrollments EnrollmentByBirthYearToMysqlTask \
--interval-start '2017-04-01' \
--interval $interval \
--remote-log-level "DEBUG" \
--source '["hdfs://localhost:9000/data"]' \
--pattern $pattern \
--warehouse-path 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse'  \
--overwrite-n-days $overwritendays \
--n-reduce-task $nreducetask \
--mapreduce-engine "hadoop" 

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights/' \
luigi --module enrollments EnrollmentByEducationLevelMysqlTask \
--interval-start '2017-04-01' \
--interval $interval \
--remote-log-level "DEBUG" \
--source '["hdfs://localhost:9000/data"]' \
--pattern $pattern \
--warehouse-path 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse'  \
--overwrite-n-days $overwritendays \
--n-reduce-task $nreducetask \
--mapreduce-engine "hadoop" 

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights/' \
luigi --module enrollments EnrollmentByGenderMysqlTask \
--interval-start '2017-04-01' \
--interval $interval \
--remote-log-level "DEBUG" \
--source '["hdfs://localhost:9000/data"]' \
--pattern $pattern \
--warehouse-path 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse'  \
--overwrite-n-days $overwritendays \
--n-reduce-task $nreducetask \
--mapreduce-engine "hadoop" 

### End ###

### Enrollment Daily ###

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' luigi   \
--module enrollments EnrollmentDailyMysqlTask \
--interval $interval \
--source '["hdfs://localhost:9000/data/"]' \
--pattern $pattern \
--warehouse-path 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse'  \
--n-reduce-task $nreducetask \
--overwrite-n-days $overwritendays \
--mapreduce-engine "hadoop" \
--remote-log-level "DEBUG" \
### End ###

### Course Activity ###
PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' \
luigi --module user_activity InsertToMysqlCourseActivityTask \
--remote-log-level "DEBUG" \
--overwrite-n-days $overwritendays \
--overwrite-mysql \
--overwrite-hive 
### End ###

### Module Engagement ###
vardate=$(date +%Y-%m-%d)

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' \
luigi --module module_engagement ModuleEngagementWorkflowTask \
--warehouse 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse/' \
--remote-log-level "DEBUG" \
--date $vardate \
--overwrite
### END ###


### Answer Distribution (Performance) ####

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights/' luigi --module answer_dist \
AnswerDistributionWorkflow \
--mapreduce-engine hadoop \
--remote-log-level "DEBUG" \
--database reports \
--credentials "/edx/etc/edx-analytics-pipeline/output.json" \
--name answer \
--src '["hdfs://localhost:9000/data"]' \
--dest "hdfs://localhost:9000/tmp/pipeline-task-scheduler/AnswerDistributionWorkflow" \
--overwrite \
--output-root 'hdfs://localhost:9000/edx-analytics-pipeline/event-export-by-course/output/' \
--marker "hdfs://localhost:9000/edx-analytics-pipeline/marker/" \
--include $pattern

### end ###

### Problem Response ###
#marker='hdfs://localhost:9000/edx-analytics-pipeline/marker/'
#outputroot='hdfs://localhost:9000/problem-response-reports/output/'
#interval=2017-04-01-$(date +%Y-%m-%d)

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' \
luigi --module problem_response ProblemResponseReportTask \
--marker $marker \
--output-root $problemoutputroot \
--overwrite

#marker='hdfs://localhost:9000/edx-analytics-pipeline/marker/'
#problemoutputroot='hdfs://localhost:9000/problem-response-reports/output/'
#interval=2017-04-01-$(date +%Y-%m-%d)

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/' \
luigi --module insights.problem_response ProblemResponseReportWorkflow \
--marker $marker \
--output-root $problemoutputroot \
--overwrite 
### END ###

### Video ####

PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights' \
luigi --module video InsertToMysqlAllVideoTask \
--remote-log-level "DEBUG" \
--overwrite-n-days $overwritendays \
--interval $interval

### END ###

###insights main dashboard 
PYTHONPATH='/edx/app/hadoop/pipeline/local/lib/python2.7/site-packages/edx/analytics/tasks/insights/' \
luigi --module enrollments CourseMetaSummaryEnrollmentIntoMysql  \
--interval $interval \
--source '["hdfs://localhost:9000/data"]' \
--pattern $pattern \
--warehouse-path 'hdfs://localhost:9000/edx-analytics-pipeline/warehouse'  \
--n-reduce-task $nreducetask \
--overwrite-n-days $overwritendays \
--mapreduce-engine "hadoop" \
--remote-log-level "DEBUG" \
--override-hive True \
--override-mysql True 
###end###
